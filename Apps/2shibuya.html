<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>看板視認範囲</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.82/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.82/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        #cesiumContainer {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <script>
        // Cesium Ionのアクセストークンを設定
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5N2UyMjcwOS00MDY1LTQxYjEtYjZjMy00YTU0ZTg5MmViYWQiLCJpZCI6ODAzMDYsImlhdCI6MTY0Mjc0ODI2MX0.dkwAL1CcljUV7NA7fDbhXXnmyZQU_c-G5zRx8PtEcxE'; // ここにアクセストークンを入力

        // B. terrainProviderを設定
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: new Cesium.CesiumTerrainProvider({
          url: Cesium.IonResource.fromAssetId(770371)
      })
    }
    );
        // PLATEAU建物データの読み込み（渋谷駅周辺）
        var tileset = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://assets.cms.plateau.reearth.io/assets/2a/090b53-0af1-4dac-9d77-67eddc26bf7a/13113_shibuya-ku_pref_2023_citygml_2_op_bldg_3dtiles_13113_shibuya-ku_lod2/tileset.json' // PLATEAUの建物データURL
        }));

    // カメラを渋谷駅周辺に移動
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(139.701, 35.658, 1000.0)
    });

    // 看板の位置を指定（経度, 緯度, 高度）※必要に応じて変更してください
    var billboardPosition = Cesium.Cartesian3.fromDegrees(139.701, 35.658, 50.0);

    // 地上での視点の高さ（人の目の高さ）を設定（単位：メートル）
    var eyeHeight = 1.5;

    // 地上レベルで、かつ建物（PLATEAUタイル）に遮られていない視認範囲を計算し、ポリゴンとして描画する関数
    async function calculateVisibility() {
      // 建物タイルセットの読み込み完了を待つ
      await buildingTileset.readyPromise;

      // サンプル点の作成
      // （ここでは、看板の位置を中心とした半径100mの円周上に、10度刻みで点を生成しています）
      var radius = 100; // 半径：100m
      var sampleCartographics = [];
      var angleStep = 10; // 例：10度刻み（360/10 = 36点）
      // 看板の位置の経度・緯度（例として固定値：139.701, 35.658）
      var centerLon = 139.701;
      var centerLat = 35.658;
      for (var angle = 0; angle < 360; angle += angleStep) {
        var rad = Cesium.Math.toRadians(angle);
        // おおよその変換：1度あたり111320m（経度・緯度は若干異なるので、簡易計算）
        var deltaLon = (radius * Math.cos(rad)) / 111320.0;
        var deltaLat = (radius * Math.sin(rad)) / 110574.0;
        var sampleLon = centerLon + deltaLon;
        var sampleLat = centerLat + deltaLat;
        // 高度は 0 として Cartographic オブジェクトを作成（後で terrain でサンプリング）
        sampleCartographics.push(Cesium.Cartographic.fromDegrees(sampleLon, sampleLat, 0));
      }

      // terrainProvider を用いて、各サンプル点の地形高度を取得する
      Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, sampleCartographics).then(function(updatedPositions) {
        var visiblePositions = [];
        updatedPositions.forEach(function(carto) {
          // 各サンプル点の「実際の地上位置」から眼の高さを加算
          var groundPoint = Cesium.Cartesian3.fromRadians(carto.longitude, carto.latitude, carto.height + eyeHeight);

          // 看板までの方向ベクトルを計算
          var direction = Cesium.Cartesian3.normalize(
            Cesium.Cartesian3.subtract(billboardPosition, groundPoint, new Cesium.Cartesian3()),
            new Cesium.Cartesian3()
          );
          // groundPoint から看板への Ray を作成
          var ray = new Cesium.Ray(groundPoint, direction);

          // Ray に沿って、最初にヒットするオブジェクトを取得
          var picked = viewer.scene.pick(ray);

          // picked が存在し、なおかつその primitive が建物タイルセットの一部（Cesium3DTileset）であれば、建物によって遮られていると判断
          if (picked && picked.primitive && (picked.primitive instanceof Cesium.Cesium3DTileset)) {
            // このサンプル点は建物に遮られているので visiblePositions に追加しない
            return;
          }
          // それ以外の場合は、地上視点から看板が見えるとして、リストに追加
          visiblePositions.push(groundPoint);
        });

        // 十分な点があれば、ポリゴンとして視認範囲を描画
        if (visiblePositions.length > 2) {
          viewer.entities.add({
            name: "地上レベルの視認範囲 (建物除外)",
            polygon: {
              hierarchy: new Cesium.PolygonHierarchy(visiblePositions),
              material: Cesium.Color.BLUE.withAlpha(0.5),
              outline: true,
              outlineColor: Cesium.Color.BLACK
            }
          });
        } else {
          console.log("十分な視認範囲のサンプル点が得られませんでした。");
        }
      });
    }

    // 関数を実行
    calculateVisibility();
  </script>
</body>
</html>
        