<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>看板視認範囲</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.82/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.82/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        #cesiumContainer {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <script>
        // Cesium Ionのアクセストークンを設定
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5N2UyMjcwOS00MDY1LTQxYjEtYjZjMy00YTU0ZTg5MmViYWQiLCJpZCI6ODAzMDYsImlhdCI6MTY0Mjc0ODI2MX0.dkwAL1CcljUV7NA7fDbhXXnmyZQU_c-G5zRx8PtEcxE'; // ここにアクセストークンを入力

        // B. terrainProviderを設定
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: new Cesium.CesiumTerrainProvider({
          url: Cesium.IonResource.fromAssetId(770371)
      })
    }
    );
        // PLATEAU建物データの読み込み（渋谷駅周辺）
        var tileset = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://assets.cms.plateau.reearth.io/assets/2a/090b53-0af1-4dac-9d77-67eddc26bf7a/13113_shibuya-ku_pref_2023_citygml_2_op_bldg_3dtiles_13113_shibuya-ku_lod2/tileset.json' // PLATEAUの建物データURL
        }));

        // カメラを渋谷駅周辺に移動
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(139.700609, 35.660158, 1000.0)
        });

        // 看板の位置を指定
        var billboardPosition = Cesium.Cartesian3.fromDegrees(139.700609, 35.660158, 18.0); // 看板の位置（経度, 緯度, 高さ）

        // 地上の人の高さを設定
        var personHeight = 1.5; // 地上の人の高さ（メートル）

        // 視認範囲を計算する関数
        function calculateVisibility() {
            var visibleArea = []; // 視認可能な地上範囲を格納する配列

            // サンプルポイントを生成（例: 半径100mの範囲を分割）
            var radius = 100; // 半径（メートル）
            var step = 10; // サンプル間隔（メートル）
            for (var angle = 0; angle < 360; angle += 10) {
                var radians = Cesium.Math.toRadians(angle);
                var offsetX = radius * Math.cos(radians);
                var offsetY = radius * Math.sin(radians);

                // サンプルポイントの座標を計算
                var samplePosition = Cesium.Cartesian3.fromDegrees(
                    139.701 + offsetX / 111320, // 経度のオフセット（1度あたり約111.32km）
                    35.658 + offsetY / 110574, // 緯度のオフセット（1度あたり約110.57km）
                    personHeight // 地上の人の高さ
                );

                // 視線が遮られていないかを判定
                var ray = new Cesium.Ray(samplePosition, billboardPosition);
                var intersection = viewer.scene.pickFromRay(ray);
                if (!intersection) {
                    visibleArea.push(samplePosition);
                }
            }

            // 視認範囲を地図上に描画
            viewer.entities.add({
                name: "視認範囲",
                polygon: {
                    hierarchy: visibleArea,
                    material: Cesium.Color.BLUE.withAlpha(0.5),
                    outline: true,
                    outlineColor: Cesium.Color.BLACK
                }
            });
        }

        // 視認範囲を計算
        calculateVisibility();
    </script>
</body>
</html>